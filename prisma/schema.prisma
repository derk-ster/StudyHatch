datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum UserRole {
  teacher
  student
}

enum LeaderboardType {
  total_points
  weekly_points
  quiz_accuracy
  games_won
  streak_days
}

model User {
  id           String               @id @default(cuid())
  email        String               @unique
  username     String               @unique
  passwordHash String
  role         UserRole             @default(student)
  image        String?
  createdAt    DateTime             @default(now())
  memberships  ClassroomMembership[]
  schools      SchoolTeacher[]
  leaderboards ClassroomLeaderboard[]
}

model School {
  id          String          @id @default(cuid())
  name        String
  description String?
  inviteCode  String          @unique
  createdById String
  createdBy   User            @relation(fields: [createdById], references: [id])
  createdAt   DateTime        @default(now())
  teachers    SchoolTeacher[]
  classrooms  ClassRoom[]
}

model SchoolTeacher {
  id        String   @id @default(cuid())
  schoolId  String
  teacherId String
  school    School   @relation(fields: [schoolId], references: [id])
  teacher   User     @relation(fields: [teacherId], references: [id])
  joinedAt  DateTime @default(now())

  @@unique([schoolId, teacherId])
}

model ClassRoom {
  id          String                @id @default(cuid())
  schoolId    String
  name        String
  description String?
  joinCode    String                @unique
  ownerId     String
  createdAt   DateTime              @default(now())
  school      School                @relation(fields: [schoolId], references: [id])
  owner       User                  @relation(fields: [ownerId], references: [id])
  memberships ClassroomMembership[]
  settings    ClassroomSettings?
  leaderboards ClassroomLeaderboard[]
}

model ClassroomMembership {
  id         String   @id @default(cuid())
  classroomId String
  userId     String
  role       UserRole @default(student)
  joinedAt   DateTime @default(now())
  classroom  ClassRoom @relation(fields: [classroomId], references: [id])
  user       User     @relation(fields: [userId], references: [id])

  @@unique([classroomId, userId])
}

model ClassroomSettings {
  id                      String          @id @default(cuid())
  classroomId             String          @unique
  defaultLeaderboardType  LeaderboardType @default(total_points)
  aiTutorEnabled          Boolean         @default(false)
  studentDecksEnabled     Boolean         @default(false)
  multiplayerEnabled      Boolean         @default(true)
  updatedAt               DateTime        @updatedAt
  updatedById             String?
  classroom               ClassRoom       @relation(fields: [classroomId], references: [id])
}

model ClassroomLeaderboard {
  id              String   @id @default(cuid())
  classroomId     String
  userId          String
  totalPoints     Int      @default(0)
  weeklyPoints    Int      @default(0)
  quizAccuracy    Float    @default(0)
  quizAttempts    Int      @default(0)
  quizCorrect     Int      @default(0)
  gamesWon        Int      @default(0)
  streakDays      Int      @default(0)
  lastWeekResetAt DateTime @default(now())
  updatedAt       DateTime @updatedAt
  classroom       ClassRoom @relation(fields: [classroomId], references: [id])
  user            User     @relation(fields: [userId], references: [id])

  @@unique([classroomId, userId])
  @@index([classroomId])
}
